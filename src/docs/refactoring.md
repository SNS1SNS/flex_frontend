# Документация по рефакторингу компонента TrackMap

## Общее описание

Данный рефакторинг был выполнен для улучшения структуры, производительности и масштабируемости компонента `TrackMap`. Основными целями рефакторинга были:

1. Извлечение логики работы с localStorage в отдельный кастомный хук
2. Перенос API-запросов в отдельный сервисный файл
3. Создание кастомного хука для работы с картой Leaflet
4. Разделение UI-элементов управления на отдельные компоненты
5. Замена глобальных переменных на React-состояние или Context API
6. Использование современных инструментов для работы с датами
7. Улучшение управления состоянием
8. Добавление обработки ошибок
9. Управление разделенным экраном через Context API
10. Документирование функций и компонентов

## Созданные компоненты и модули

### Кастомные хуки

1. **useLocalStorageSync** (`src/hooks/useLocalStorageSync.js`)
   - Управление синхронизацией с localStorage для сохранения выбранного ТС, периода дат и режима разделенного экрана
   - Обработка изменений localStorage между различными вкладками
   - Проверка валидности данных

2. **useLeafletMap** (`src/hooks/useLeafletMap.js`)
   - Инициализация и управление картой Leaflet
   - Отрисовка треков на карте
   - Управление маркерами и линиями
   - Анимация движения маркера
   - Воспроизведение трека
   - Экспорт карты

### API и сервисы

1. **trackService** (`src/api/trackService.js`)
   - Функция `fetchTrackData` для получения данных трека
   - Обработка ошибок и повторные попытки
   - Кэширование результатов
   - Вычисление статистики трека

2. **exportTrackData** (`src/utils/exportTrackData.js`)
   - Экспорт данных трека в различные форматы (CSV, GPX, JSON)
   - Выбор формата экспорта через диалоговое окно
   - Форматирование данных для экспорта

### Компоненты UI

1. **MapControls** (`src/components/controls/MapControls.js`)
   - Элементы управления для карты
   - Выбор ТС и периода
   - Управление воспроизведением
   - Кнопки для экспорта, статистики и разделения экрана

2. **TrackStatistics** (`src/components/statistics/TrackStatistics.js`)
   - Отображение статистики по треку
   - Форматирование и группировка данных

### Контекст и управление разделенным экраном

1. **SplitScreenContext** (`src/contexts/SplitScreenContext.js`)
   - Глобальное состояние для разделенного экрана
   - Методы для изменения режима разделения, активации контейнеров
   - История состояний для возможности отмены

2. **SplitScreenManager** (`src/utils/SplitScreenManager.js`)
   - Низкоуровневая логика работы с DOM для разделения экрана
   - Управление контейнерами и их состоянием
   - Различные режимы разделения экрана

## Изменения в основном компоненте TrackMap

1. **Структурные изменения**
   - Использование кастомных хуков вместо встроенной логики
   - Разделение функциональности по задачам
   - Использование контекста для разделенного экрана

2. **Улучшение производительности**
   - Мемоизация компонентов (`React.memo`)
   - Использование `useCallback` и `useMemo` для оптимизации рендеринга
   - Вынесение сложных вычислений за пределы основного компонента

3. **Улучшение пользовательского опыта**
   - Добавление индикаторов загрузки
   - Более информативные сообщения об ошибках
   - Улучшенные контролы и интерфейс

## Преимущества рефакторинга

1. **Улучшенная поддерживаемость**
   - Модульный код легче поддерживать и расширять
   - Документированные компоненты и функции
   - Чёткое разделение ответственности

2. **Повышенная переиспользуемость**
   - Кастомные хуки могут быть использованы в других компонентах
   - Модульная структура позволяет легко встраивать компоненты в различные части приложения

3. **Лучшая масштабируемость**
   - Удобно добавлять новые функции
   - Легче тестировать отдельные модули
   - Проще находить и исправлять ошибки

4. **Улучшенная производительность**
   - Оптимизация рендеринга
   - Кэширование данных
   - Эффективное управление состоянием

## Дальнейшие улучшения

Несмотря на значительные улучшения, всегда есть возможности для дальнейшего совершенствования:

1. Добавление тестов (unit, integration)
2. Реализация серверного рендеринга для улучшения SEO
3. Интернационализация (i18n) для поддержки нескольких языков
4. Оптимизация для мобильных устройств (PWA)
5. Интеграция с аналитикой и мониторингом
6. Расширение функциональности экспорта и анализа данных 